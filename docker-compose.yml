# Browser Automation Toolkit - Docker Compose
#
# Usage:
#   docker compose up -d          # Start services in background
#   docker compose logs -f        # View logs
#   docker compose down           # Stop services
#   docker compose run --rm test  # Run tests
#
# Note: The server runs in Docker, but the Chrome extension runs in your browser.
# Configure the extension's server URL to point to this container (default: http://127.0.0.1:8766)

services:
  browser-toolkit:
    container_name: cowoai-browser-toolkit
    build: .
    ports:
      - "8766:8766"
    environment:
      - PORT=8766
      - HOST=0.0.0.0
      - COMMAND_TIMEOUT=30000
      - DATABASE_URL=postgres://cowoai:cowoai@cowoai-toolkit-postgres:5432/browser_toolkit?sslmode=disable
    volumes:
      - ./data:/app/data
    depends_on:
      postgres:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:8766/"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 5s

  postgres:
    container_name: cowoai-toolkit-postgres
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=cowoai
      - POSTGRES_PASSWORD=cowoai
      - POSTGRES_DB=browser_toolkit
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./migrations/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5434:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U cowoai -d browser_toolkit"]
      interval: 5s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Test service - runs tests against PostgreSQL
  test:
    build: .
    environment:
      - DATABASE_URL=postgres://cowoai:cowoai@cowoai-toolkit-postgres:5432/browser_toolkit?sslmode=disable
    depends_on:
      postgres:
        condition: service_healthy
    volumes:
      - ./tests:/app/tests:ro
    command: ["sh", "-c", "node --test /app/tests/*.test.js"]
    profiles:
      - test

volumes:
  postgres_data:
